# API ä½™é¢ç›‘æ§çœ‹æ¿ - Cloudflare Workers ç‰ˆæœ¬

åŸºäº Cloudflare Workers + D1 æ•°æ®åº“çš„ API Key ä½™é¢ç›‘æ§ç³»ç»Ÿï¼Œæ”¯æŒå®æ—¶æŸ¥è¯¢ã€æ‰¹é‡ç®¡ç†å’Œæ•°æ®å¯¼å‡ºã€‚

## âœ¨ ç‰¹æ€§

- ğŸš€ **å¼ºä¸€è‡´æ€§å­˜å‚¨**ï¼šä½¿ç”¨ D1 æ•°æ®åº“ï¼Œå†™å…¥åç«‹å³å¯è¯»
- ğŸ“Š **å®æ—¶ç›‘æ§**ï¼šå®æ—¶æŸ¥è¯¢ API Key ä½¿ç”¨æƒ…å†µå’Œä½™é¢
- ğŸ” **å®‰å…¨è®¤è¯**ï¼šæ”¯æŒå¯†ç ç™»å½•å’Œä¼šè¯ç®¡ç†
- ğŸ“¥ **æ‰¹é‡ç®¡ç†**ï¼šæ”¯æŒæ‰¹é‡å¯¼å…¥ã€å¯¼å‡ºå’Œåˆ é™¤ API Keys
- ğŸ¨ **ç¾è§‚ç•Œé¢**ï¼šç°ä»£åŒ–çš„å“åº”å¼ Web ç•Œé¢
- âš¡ **é«˜æ€§èƒ½**ï¼šåŸºäº Cloudflare Workers è¾¹ç¼˜è®¡ç®—
- ğŸ”„ **è‡ªåŠ¨åˆ·æ–°**ï¼šæ”¯æŒå®šæ—¶è‡ªåŠ¨åˆ·æ–°æ•°æ®

## ğŸ—ï¸ æŠ€æœ¯æ ˆ

- **è¿è¡Œæ—¶**ï¼šCloudflare Workers
- **æ•°æ®åº“**ï¼šCloudflare D1 (SQLite)
- **è¯­è¨€**ï¼šTypeScript
- **éƒ¨ç½²å·¥å…·**ï¼šWrangler

## ğŸ“¦ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Node.js 16+
- npm æˆ– yarn
- Cloudflare è´¦å·

### 1. å…‹éš†é¡¹ç›®

```bash
git clone <repository-url>
cd droid-apikey
```

### 2. å®‰è£…ä¾èµ–

```bash
npm install
```

### 3. åˆ›å»º D1 æ•°æ®åº“

```bash
# åˆ›å»ºç”Ÿäº§ç¯å¢ƒæ•°æ®åº“
npm run d1:create

# è®°å½•è¿”å›çš„ database_id
```

### 4. é…ç½® wrangler.toml

å°†åˆ›å»ºæ•°æ®åº“æ—¶è¿”å›çš„ `database_id` å¡«å…¥ [`wrangler.toml`](wrangler.toml:7)ï¼š

```toml
[[d1_databases]]
binding = "DB"
database_name = "droid-apikey-db"
database_id = "YOUR_D1_DATABASE_ID"  # æ›¿æ¢ä¸ºå®é™…çš„ database_id
```

### 5. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
# ç”Ÿäº§ç¯å¢ƒ
npm run d1:migrate

# æœ¬åœ°å¼€å‘ç¯å¢ƒ
npm run d1:migrate:local
```

### 6. æœ¬åœ°å¼€å‘

```bash
# ä½¿ç”¨è¿œç¨‹ D1 æ•°æ®åº“
npm run dev

# ä½¿ç”¨æœ¬åœ° D1 æ•°æ®åº“
npm run dev:local
```

è®¿é—® http://localhost:8787

### 7. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

```bash
npm run deploy
```

## ğŸ”„ ä» KV è¿ç§»åˆ° D1

å¦‚æœä½ ä¹‹å‰ä½¿ç”¨çš„æ˜¯ KV å­˜å‚¨ï¼Œè¯·å‚è€ƒ [è¿ç§»æŒ‡å—](MIGRATION_GUIDE.md) è¿›è¡Œæ•°æ®è¿ç§»ã€‚

**è¿ç§»åŸå› ï¼š**
- KV æ˜¯æœ€ç»ˆä¸€è‡´æ€§å­˜å‚¨ï¼Œå†™å…¥åéœ€è¦çº¦ 60 ç§’æ‰èƒ½å…¨çƒåŒæ­¥
- D1 æä¾›å¼ºä¸€è‡´æ€§ï¼Œå†™å…¥åç«‹å³å¯è¯»
- D1 æ”¯æŒ SQL æŸ¥è¯¢ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§

## ğŸ“ ä½¿ç”¨è¯´æ˜

### ç™»å½•

é»˜è®¤è´¦å·å’Œå¯†ç éƒ½æ˜¯ `wrangler.toml` ä¸­é…ç½®çš„ `EXPORT_PASSWORD`ï¼ˆé»˜è®¤ï¼š`zhaoweihao98`ï¼‰

**âš ï¸ é‡è¦ï¼š** éƒ¨ç½²å‰è¯·ä¿®æ”¹å¯†ç ï¼

### ç®¡ç† API Keys

1. **æ·»åŠ  Key**ï¼šç‚¹å‡»"Key ç®¡ç†"æŒ‰é’®ï¼Œåœ¨æ‰¹é‡å¯¼å…¥æ¡†ä¸­è¾“å…¥ Keysï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
2. **æŸ¥çœ‹ä½™é¢**ï¼šä¸»ç•Œé¢æ˜¾ç¤ºæ‰€æœ‰ Keys çš„ä½™é¢å’Œä½¿ç”¨æƒ…å†µ
3. **åˆ·æ–°æ•°æ®**ï¼šç‚¹å‡»"åˆ·æ–°æ•°æ®"æŒ‰é’®æ›´æ–°æ‰€æœ‰ Keys çš„ä¿¡æ¯
4. **åˆ é™¤ Key**ï¼š
   - å•ä¸ªåˆ é™¤ï¼šç‚¹å‡»è¡¨æ ¼ä¸­çš„"åˆ é™¤"æŒ‰é’®
   - æ‰¹é‡åˆ é™¤æ— æ•ˆ Keyï¼šç‚¹å‡»"åˆ é™¤æ— æ•ˆ"æŒ‰é’®
   - åˆ é™¤æ‰€æœ‰ Keyï¼šç‚¹å‡»"åˆ é™¤æ‰€æœ‰"æŒ‰é’®
5. **å¯¼å‡º Keys**ï¼šç‚¹å‡»"å¯¼å‡ºKey"æŒ‰é’®ï¼Œè¾“å…¥å¯†ç åä¸‹è½½

### API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/` | GET | ä¸»é¡µé¢ |
| `/api/login` | POST | ç™»å½• |
| `/api/logout` | POST | ç™»å‡º |
| `/api/data` | GET | è·å–æ‰€æœ‰ Keys çš„ä½¿ç”¨æ•°æ® |
| `/api/keys` | GET | è·å–æ‰€æœ‰ Keys |
| `/api/keys` | POST | æ·»åŠ  Keyï¼ˆæ”¯æŒæ‰¹é‡ï¼‰ |
| `/api/keys/:id` | DELETE | åˆ é™¤æŒ‡å®š Key |
| `/api/keys/:id/refresh` | POST | åˆ·æ–°æŒ‡å®š Key çš„æ•°æ® |
| `/api/keys/batch-delete` | POST | æ‰¹é‡åˆ é™¤ Keys |
| `/api/keys/export` | POST | å¯¼å‡ºæ‰€æœ‰ Keysï¼ˆéœ€è¦å¯†ç ï¼‰ |

## ğŸ› ï¸ å¼€å‘å‘½ä»¤

```bash
# æœ¬åœ°å¼€å‘ï¼ˆä½¿ç”¨è¿œç¨‹ D1ï¼‰
npm run dev

# æœ¬åœ°å¼€å‘ï¼ˆä½¿ç”¨æœ¬åœ° D1ï¼‰
npm run dev:local

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
npm run deploy

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
npm run tail

# åˆ›å»º D1 æ•°æ®åº“
npm run d1:create

# è¿è¡Œæ•°æ®åº“è¿ç§»
npm run d1:migrate

# æŸ¥è¯¢ D1 æ•°æ®åº“
npm run d1:query "SELECT * FROM api_keys LIMIT 10"

# å¤‡ä»½ D1 æ•°æ®åº“
npm run d1:backup
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
droid-apikey/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ index.ts              # ä¸»åº”ç”¨ä»£ç 
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 0001_create_api_keys_table.sql  # æ•°æ®åº“è¿ç§»è„šæœ¬
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ migrate_kv_to_d1.ts   # KV åˆ° D1 è¿ç§»è„šæœ¬
â”œâ”€â”€ wrangler.toml             # Cloudflare Workers é…ç½®
â”œâ”€â”€ package.json              # é¡¹ç›®ä¾èµ–å’Œè„šæœ¬
â”œâ”€â”€ tsconfig.json             # TypeScript é…ç½®
â”œâ”€â”€ MIGRATION_GUIDE.md        # è¿ç§»æŒ‡å—
â””â”€â”€ README.md                 # æœ¬æ–‡ä»¶
```

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ä¿®æ”¹é»˜è®¤å¯†ç **ï¼šåœ¨ [`wrangler.toml`](wrangler.toml:12) ä¸­ä¿®æ”¹ `EXPORT_PASSWORD`
2. **ä½¿ç”¨ç¯å¢ƒå˜é‡**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Cloudflare Workers çš„ Secretsï¼š
   ```bash
   npx wrangler secret put EXPORT_PASSWORD
   ```
3. **é™åˆ¶è®¿é—®**ï¼šè€ƒè™‘æ·»åŠ  IP ç™½åå•æˆ–å…¶ä»–è®¿é—®æ§åˆ¶
4. **å®šæœŸå¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½ D1 æ•°æ®åº“

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

- âœ… ä½¿ç”¨ D1 æ•°æ®åº“ç´¢å¼•åŠ é€ŸæŸ¥è¯¢
- âœ… æ‰¹é‡å¤„ç† API è¯·æ±‚ï¼Œé¿å…é€Ÿç‡é™åˆ¶
- âœ… æœåŠ¡ç«¯ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
- âœ… è¾¹ç¼˜è®¡ç®—é™ä½å»¶è¿Ÿ

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ [`wrangler.toml`](wrangler.toml:7) ä¸­çš„ `database_id` æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤å·²è¿è¡Œæ•°æ®åº“è¿ç§»ï¼š`npm run d1:migrate`
3. æŸ¥çœ‹æ—¥å¿—ï¼š`npm run tail`

### é—®é¢˜ï¼šå†™å…¥åæ— æ³•ç«‹å³æŸ¥è¯¢

**è§£å†³æ–¹æ¡ˆï¼š**
- å¦‚æœä½¿ç”¨çš„æ˜¯ KVï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰
- å»ºè®®è¿ç§»åˆ° D1 æ•°æ®åº“ï¼Œå‚è€ƒ [è¿ç§»æŒ‡å—](MIGRATION_GUIDE.md)

### é—®é¢˜ï¼šéƒ¨ç½²å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®è®¤å·²ç™»å½• Cloudflareï¼š`npx wrangler login`
2. æ£€æŸ¥ `wrangler.toml` é…ç½®æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Cloudflare Workers æ–‡æ¡£](https://developers.cloudflare.com/workers/)
- [Cloudflare D1 æ–‡æ¡£](https://developers.cloudflare.com/d1/)
- [Wrangler CLI æ–‡æ¡£](https://developers.cloudflare.com/workers/wrangler/)
- [è¿ç§»æŒ‡å—](MIGRATION_GUIDE.md)

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“® è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issueã€‚